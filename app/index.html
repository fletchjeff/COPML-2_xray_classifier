<!DOCTYPE html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<head>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
  <style>
    @import url('https://fonts.googleapis.com/css?family=Open+Sans');

    body {
      font-family: 'Open Sans', sans-serif;
      max-width: 500px;
      margin: auto;
    }
    .header {
        font-family: 'Open Sans', sans-serif;
        font-weight: 300;
        font-size: 35px;
        text-align: center;
        padding-top: 20px;
        vertical-align: top;
        line-height: 55px;
    }
    .content{
      max-width: 460px;
      margin: auto;
    }
    #result {
      font-size: 1.2em;
    }
    .btn {
      width: 200px;
      float: left;
      color: white;
      background: #aaa;
      border: 5px solid #aaa;
      border-radius: 6px;

      padding: 8px 8px;
      text-align: center;
      display: inline-block;
      font-size: 1.2em;
      margin: 4px 2px;
      -webkit-transition-duration: 0.4s;
      /* Safari */
      transition-duration: 0.4s;
      cursor: pointer;
      text-decoration: none;
      text-transform: uppercase;
    }

    #test_image {
          display:block;
          width:100%;
          height:500px;
          background-color:#eee;
          overflow:hidden;

    }
  </style>
  <script>
    let url = 'https://modelservice.ml-18a296af-d86.demo-aws.ylcu-atmi.cloudera.site/model';
    let api_key_1 = "my87udph3c9up73g7nwv3b3pdt1hzf4h"
    let api_key_2 = "mgp9zye1k3rfx7hik70oeaibk4tw08rk"
    let image_name = "img_test_pneumonia"

    function go_fetch(img_name) {
      let image_data = getBase64Image(document.getElementById(img_name))
      let post_data_1 = {
        accessKey: api_key_1,
        request: {
          image: image_data
        }
      };

      fetch(url, {
          method: 'POST', // or 'PUT'
          body: JSON.stringify(post_data_1), // data can be `string` or {object}!
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(res => res.json())
        .then(function (response) {
          d3.select("#prediction_model_1").text("Prediction Model 1 : " + response.response.prediction + " (" + response.response.prediction_value.toFixed(5) + ")")
          if (response.response.prediction != "normal" ){
                    let post_data_2 = {
                    accessKey: api_key_2,
                    request: {
                      image: image_data
                    }
                  };

                  fetch(url, {
                      method: 'POST', // or 'PUT'
                      body: JSON.stringify(post_data_2), // data can be `string` or {object}!
                      headers: {
                        'Content-Type': 'application/json'
                      }
                    })
                    .then(res => res.json())
                    .then(function (response) {
                      d3.select("#prediction_model_2").text("Prediction Model 2 : " + response.response.prediction + " (" + response.response.prediction_value.toFixed(5) + ")")
                    })
                    .catch(error => console.error('Error:', error));  
              }
        })
        .catch(error => console.error('Error:', error));
          
    }

    function getBase64Image(img) {
      var canvas = document.createElement("canvas");
      scaling = document.getElementById("img_test_normal").naturalWidth / 1000
      canvas.width = img.naturalWidth / scaling;
      canvas.height = img.naturalHeight / scaling;
      var ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL("image/png");
    }

    function get_new_image() {
      d3.select("#prediction_model_1").text("Prediction Model 1 : ...")
      d3.select("#prediction_model_2").text("Prediction Model 2 : ...")
      fetch(window.location.origin + "/random_image", {
          method: 'GET', // or 'PUT'
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(res => res.json())
        .then(function (response) {
          d3.select("#img_test_normal").attr("src", "/" + response.file)
          d3.select("#actual_value").text("Actual Value : " + response.file.substring(response.file.indexOf("/")+6,response.file.lastIndexOf("/")))
          d3.select("#prediction").text("Prediction : ")
          d3.select("#prediction_value").text("Prediction Value : ")
        })
        .catch(error => console.error('Error:', error));
    }
  </script>
</head>

<body>
  <div class="header">X-ray Classifier</div>
  <div class="container">
    <div id="test_image">
      <img id="img_test_normal" src="" width="500">
    </div>
  </div>
  <div class="content">
    <div onclick="get_new_image();" class="btn btn1">New Image</div>
    <div onclick="go_fetch('img_test_normal');" class="btn btn1">Predict</div>
    <div style="clear:both;"></div>
    <div>
      <div id="actual_value">Actual Value : </div>
      <div id="prediction_model_1">Prediction Model 1: </div>
      <div id="prediction_model_2">Prediction Model 2 : </div>
    </div>
  </div>
  <script>
    get_new_image();
  </script>

</body>

</html>